<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Waver | Ultimate</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    /* ================= VARIABLES ================= */
    :root {
      --bg-main: #050a14;
      --bg-glass: rgba(10, 20, 40, 0.65);
      --card-bg: rgba(255, 255, 255, 0.03);
      --text: #e6f0ff;
      --text-muted: rgba(230, 240, 255, 0.5);
      --accent: #00f2ff;
      --accent-glow: rgba(0, 242, 255, 0.4);
      --stroke: rgba(255, 255, 255, 0.1);
      --shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      --font-main: "Space Grotesk", sans-serif;
      --font-tech: "Oxanium", sans-serif;
      --card-radius: 24px;
    }

    body.theme-classic {
      --bg-main: #0a2a66;
      --bg-glass: rgba(255, 255, 255, 0.16);
      --card-bg: rgba(255, 255, 255, 0.16);
      --text: #e6f0ff;
      --text-muted: rgba(230, 240, 255, 0.65);
      --accent: #7bd3ff;
      --accent-glow: rgba(123, 211, 255, 0.2);
      --stroke: rgba(255, 255, 255, 0.35);
      --shadow: 0 30px 80px rgba(2, 16, 45, 0.45);
      --font-main: "Oxanium", sans-serif;
      --card-radius: 26px;
    }

    /* ================= BASE ================= */
    * { box-sizing: border-box; user-select: none; outline: none; }

    body {
      margin: 0;
      height: 100vh;
      font-family: var(--font-main);
      color: var(--text);
      background-color: var(--bg-main);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: background 0.5s ease;
    }

    /* ================= LAYERS & BACKGROUNDS ================= */
    
    /* 1. Layer -2: Static Backgrounds */
    .bg-layer {
      position: fixed; inset: 0; z-index: -2;
      transition: opacity 0.8s ease;
    }
    
    .bg-modern {
      opacity: 1;
      background: radial-gradient(circle at 50% 50%, #0a1124 0%, #020408 100%);
    }

    .bg-classic {
      opacity: 0;
      background:
        radial-gradient(1200px 800px at 10% 10%, #0d6ad4 0%, transparent 60%),
        radial-gradient(900px 600px at 90% 30%, #0d4fb4 0%, transparent 65%),
        linear-gradient(160deg, #0b5bbf, #0b3b8a 45%, #0a2a66 100%);
    }

    .scanlines {
      position: fixed; inset: 0; pointer-events: none; z-index: -2;
      background: linear-gradient(to bottom, transparent 50%, rgba(0,0,0,0.2) 50%);
      background-size: 100% 4px;
      opacity: 0.4;
    }

    /* 2. Layer -1: Dynamic Mouse Glow (Modern Only) */
    .cursor-glow {
      position: fixed;
      top: 0; left: 0;
      width: 600px; height: 600px;
      background: radial-gradient(circle, rgba(0, 242, 255, 0.12) 0%, transparent 70%);
      transform: translate(-50%, -50%);
      pointer-events: none; /* Click through */
      z-index: -1; /* Above BG, Below Content */
      mix-blend-mode: screen;
      transition: opacity 0.5s ease;
      opacity: 1;
    }

    /* 3. Theme Overrides for Layers */
    body.theme-classic .bg-modern,
    body.theme-classic .cursor-glow, /* Hide glow in classic */
    body.theme-classic .scanlines { opacity: 0; }
    
    body.theme-classic .bg-classic { opacity: 1; }

    /* ================= TOP TRIGGER ZONE (AUTO HIDE) ================= */
    .top-trigger-zone {
      position: fixed;
      top: 0; left: 0; width: 100%;
      height: 40px; /* المنطقة الحساسة */
      z-index: 200;
      display: flex;
      justify-content: center;
      /* Visual Debugging: background: red; opacity: 0.1; */ 
    }

    .theme-switch {
      background: var(--bg-glass);
      padding: 10px 24px;
      border-radius: 0 0 20px 20px;
      border: 1px solid var(--stroke);
      border-top: none;
      cursor: pointer;
      backdrop-filter: blur(10px);
      display: flex; align-items: center; gap: 10px;
      font-family: var(--font-tech);
      font-size: 14px; color: var(--text);
      
      /* Hidden by default */
      transform: translateY(-100%);
      transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    /* Show on Hover */
    .top-trigger-zone:hover .theme-switch {
      transform: translateY(0);
    }

    .theme-switch:hover { background: rgba(255,255,255,0.1); }

    /* ================= MAIN CONTENT (Layer 1+) ================= */
    
    /* Header */
    .header {
      padding: 40px 60px;
      display: flex; justify-content: space-between; align-items: center;
      z-index: 2; position: relative;
    }
    
    /* Classic Header Override */
    body.theme-classic .header { padding: 0; height: 0; }
    body.theme-classic .time-widget { position: fixed; top: 28px; left: 32px; }
    body.theme-classic .user-profile { 
      position: fixed; bottom: 36px; right: 40px;
      background: transparent; border: none; flex-direction: row-reverse; 
    }
    body.theme-classic .user-profile .avatar {
      width: 68px; height: 68px; background: rgba(255,255,255,0.16);
      border: 2px solid var(--stroke); font-size: 28px; color: rgba(230, 240, 255, 0.7);
    }
    body.theme-classic .user-profile .username {
      font-size: 28px; color: rgba(230, 240, 255, 0.7);
    }

    /* Time & User */
    .time-widget { font-family: var(--font-tech); transition: all 0.5s; }
    .clock {
      font-size: 48px; font-weight: 600; letter-spacing: 2px;
      text-shadow: 0 0 20px var(--accent-glow);
    }
    body.theme-classic .clock { text-shadow: 0 6px 20px rgba(0,0,0,0.2); font-weight: 300; font-size: 42px; color: rgba(230, 240, 255, 0.55); }
    .date { font-size: 16px; color: var(--text-muted); margin-top: -5px; }
    body.theme-classic .date { display: none; }

    .user-profile {
      display: flex; align-items: center; gap: 15px;
      background: var(--bg-glass); padding: 8px 16px 8px 8px;
      border-radius: 50px; border: 1px solid var(--stroke);
      backdrop-filter: blur(10px); transition: all 0.5s ease;
    }
    .avatar {
      width: 45px; height: 45px; border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), #2d5bff);
      display: grid; place-items: center;
      font-weight: bold; color: #000; font-family: var(--font-tech); font-size: 20px;
    }

    /* Library & Cards */
    .library-container {
      flex: 1; overflow-y: auto; padding: 20px 60px 100px;
      z-index: 2; position: relative;
      scrollbar-width: thin; scrollbar-color: var(--accent) transparent;
    }
    body.theme-classic .library-container { padding-top: 100px; }

    .library-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 30px; perspective: 1000px;
    }
    body.theme-classic .library-grid { gap: 20px; }

    .game-card {
      position: relative;
      background: var(--card-bg);
      border-radius: var(--card-radius);
      padding: 12px;
      border: 1px solid var(--stroke);
      backdrop-filter: blur(14px);
      transition: transform 0.1s ease-out, box-shadow 0.3s ease, border 0.3s;
      cursor: pointer; transform-style: preserve-3d;
      box-shadow: var(--shadow);
    }

    body.theme-classic .game-card {
      padding: 16px; min-height: 190px;
      display: flex; flex-direction: column; align-items: center;
      box-shadow: inset 0 0 0 2px var(--stroke), var(--shadow);
      border: none; transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .game-card:hover {
      border-color: var(--accent);
      box-shadow: 0 20px 50px var(--accent-glow);
    }
    .game-card.is-active {
      border-color: var(--accent);
      box-shadow: 0 20px 50px var(--accent-glow);
    }
    body.theme-classic .game-card:hover {
      transform: translateY(-6px) scale(1.01) !important;
      box-shadow: inset 0 0 0 2px var(--accent), 0 30px 80px rgba(0, 0, 0, 0.35);
    }
    body.theme-classic .game-card.is-active {
      transform: translateY(-6px) scale(1.01) !important;
      box-shadow: inset 0 0 0 2px var(--accent), 0 30px 80px rgba(0, 0, 0, 0.35);
    }

    .game-thumb {
      width: 100%; aspect-ratio: 1/1; border-radius: 18px;
      background: rgba(0,0,0,0.2); overflow: hidden;
      transform: translateZ(20px); transition: transform 0.4s;
    }
    body.theme-classic .game-thumb {
      transform: none; border-radius: 20px;
      background: linear-gradient(145deg, rgba(255,255,255,0.28), rgba(255,255,255,0.08));
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.15);
    }
    .game-thumb img { width: 100%; height: 100%; object-fit: cover; }

    .game-title {
      margin-top: 15px; font-family: var(--font-tech); font-size: 16px;
      text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      transform: translateZ(10px);
    }
    body.theme-classic .game-title {
      transform: none; font-size: 18px; letter-spacing: 1px;
      text-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
    }

    /* FAB */
    .fab {
      position: fixed; bottom: 40px; right: 40px;
      width: 70px; height: 70px; border-radius: 50%;
      background: var(--accent); color: #000;
      display: grid; place-items: center; font-size: 32px;
      box-shadow: 0 10px 30px var(--accent-glow);
      cursor: pointer; z-index: 10; transition: all 0.3s ease;
    }
    body.theme-classic .fab {
      right: auto; left: 40px; bottom: 36px;
      width: 88px; height: 88px; background: rgba(255,255,255,0.2);
      border: 2px solid var(--stroke); color: var(--text);
      box-shadow: var(--shadow); font-weight: 300; font-size: 48px;
    }
    body.theme-classic .fab:hover {
      transform: translateY(-4px) scale(1.03);
      border-color: var(--accent); background: rgba(255,255,255,0.2);
    }

    /* Modals & Menus */
    .empty-state {
      display: none; flex-direction: column; align-items: center; justify-content: center;
      height: 60%; color: var(--text-muted); border: 2px dashed var(--stroke);
      border-radius: 30px; margin: 20px 60px; z-index: 2;
    }
    .empty-state.visible { display: flex; }

    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.9);
      backdrop-filter: blur(20px); display: none; place-items: center;
      z-index: 50; opacity: 0; transition: opacity 0.3s;
    }
    .modal.active { display: grid; opacity: 1; }
    .game-frame-container {
      width: 90vw; height: 85vh; background: #000; border-radius: 20px;
      border: 1px solid var(--stroke); overflow: hidden; position: relative;
    }
    .close-modal {
      position: absolute; top: 20px; right: 20px; width: 40px; height: 40px;
      border-radius: 50%; background: rgba(255,255,255,0.1); color: #fff;
      border: none; cursor: pointer; font-size: 24px; z-index: 51;
    }
    iframe { width: 100%; height: 100%; border: none; }

    .context-menu {
      position: fixed; background: rgba(10, 15, 30, 0.95);
      border: 1px solid var(--stroke); border-radius: 12px; padding: 8px;
      backdrop-filter: blur(12px); display: none; flex-direction: column;
      min-width: 140px; z-index: 100;
    }
    .ctx-item { padding: 8px 12px; border-radius: 8px; font-size: 14px; cursor: pointer; color: #fff; }
    .ctx-item:hover { background: rgba(255,255,255,0.1); }
    .ctx-item.delete { color: #ff4757; }

  </style>
</head>
<body class="">

  <div class="bg-layer bg-modern"></div>
  <div class="scanlines"></div>
  <div class="cursor-glow" id="cursorGlow"></div> <div class="bg-layer bg-classic"></div>

  <div class="top-trigger-zone">
    <button class="theme-switch" id="themeToggler">
      <span>🎨 Switch Theme</span>
    </button>
  </div>

  <div class="header">
    <div class="time-widget">
      <div class="clock" id="clock">12:00</div>
      <div class="date" id="date">Tuesday, Oct 24</div>
    </div>
    <div class="user-profile">
      <div class="username" id="userName">adhm</div>
      <div class="avatar" id="userAvatar">A</div>
    </div>
  </div>

  <div class="empty-state" id="emptyState">
    <h2 style="font-size: 40px; opacity: 0.3;">📂</h2>
    <p>اسحب الألعاب هنا</p>
  </div>

  <div class="library-container">
    <div class="library-grid" id="grid"></div>
  </div>

  <div class="fab" id="addBtn">+</div>
  <input type="file" id="fileInput" accept=".html,.htm" style="display: none;" />
  <input type="file" id="avatarInput" accept="image/*" style="display: none;" />

  <div class="context-menu" id="ctxMenu">
    <div class="ctx-item delete" id="ctxDelete">حذف اللعبة</div>
  </div>

  <div class="modal" id="gameModal">
    <div class="game-frame-container">
      <button class="close-modal" id="closeGame">×</button>
      <iframe id="gameFrame"></iframe>
    </div>
  </div>

  <script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    // --- Mouse Glow Logic ---
    const glow = document.getElementById('cursorGlow');
    document.addEventListener('mousemove', (e) => {
      // نقل الضوء ليتبع الماوس (باستخدام transform لأداء أفضل)
      glow.style.transform = `translate(${e.clientX - 300}px, ${e.clientY - 300}px)`;
    });

    // --- Theme Logic ---
    const themeBtn = document.getElementById('themeToggler');
    const body = document.body;
    
    if(localStorage.getItem('theme') === 'classic') {
      body.classList.add('theme-classic');
    }

    themeBtn.addEventListener('click', () => {
      body.classList.toggle('theme-classic');
      const isClassic = body.classList.contains('theme-classic');
      localStorage.setItem('theme', isClassic ? 'classic' : 'modern');
      playSound('click');
    });

    // --- Audio ---
    function playSound(type) {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      const now = audioCtx.currentTime;
      
      if (type === 'hover') {
        if(body.classList.contains('theme-classic')) return; 
        osc.frequency.setValueAtTime(400, now);
        osc.frequency.exponentialRampToValueAtTime(600, now + 0.1);
        gain.gain.setValueAtTime(0.05, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
      } else if (type === 'click') {
        osc.type = 'square';
        osc.frequency.setValueAtTime(200, now);
        gain.gain.setValueAtTime(0.05, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
      }
      osc.start(now);
      osc.stop(now + 0.2);
    }

    // --- Main Logic ---
    const grid = document.getElementById('grid');
    const emptyState = document.getElementById('emptyState');
    const fileInput = document.getElementById('fileInput');
    const avatarInput = document.getElementById('avatarInput');
    const userNameEl = document.getElementById('userName');
    const userAvatarEl = document.getElementById('userAvatar');
    const ctxMenu = document.getElementById('ctxMenu');
    const modal = document.getElementById('gameModal');
    const frame = document.getElementById('gameFrame');
    let contextTargetId = null;
    let activeIndex = -1;

    function updateTime() {
      const d = new Date();
      document.getElementById('clock').textContent = d.toLocaleTimeString('en-US', {hour12: false, hour:'2-digit', minute:'2-digit'});
      document.getElementById('date').textContent = d.toLocaleDateString('en-US', {weekday:'long', month:'short', day:'numeric'});
    }
    setInterval(updateTime, 1000);
    updateTime();

    function createCard(id, title, iconSrc, blobUrl) {
      const card = document.createElement('div');
      card.className = 'game-card';
      card.dataset.id = id;
      card.tabIndex = 0;

      card.innerHTML = `
        <div class="game-thumb">
          <img src="${iconSrc}">
        </div>
        <div class="game-title">${title}</div>
      `;

      card.addEventListener('mousemove', (e) => {
        if(body.classList.contains('theme-classic')) return;
        const rect = card.getBoundingClientRect();
        const x = e.clientX - rect.left - rect.width / 2;
        const y = e.clientY - rect.top - rect.height / 2;
        card.style.transform = `perspective(1000px) rotateX(${y * -0.1}deg) rotateY(${x * 0.1}deg) scale(1.02)`;
      });

      card.addEventListener('mouseleave', () => {
        if(!body.classList.contains('theme-classic')) {
          card.style.transform = `perspective(1000px) rotateX(0) rotateY(0) scale(1)`;
        }
      });

      card.addEventListener('mouseenter', () => {
        playSound('hover');
        const cards = getCards();
        const index = cards.indexOf(card);
        if (index !== -1) setActiveIndex(index);
      });
      card.addEventListener('click', () => openGame(blobUrl));
      
      card.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        contextTargetId = id;
        ctxMenu.style.display = 'flex';
        ctxMenu.style.left = `${e.clientX}px`;
        ctxMenu.style.top = `${e.clientY}px`;
      });

      return card;
    }

    function addGame(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const content = e.target.result;
        const parser = new DOMParser();
        const doc = parser.parseFromString(content, 'text/html');
        let title = doc.title || file.name.replace('.html', '');
        
        let icon = `data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100" height="100" fill="%232d5bff"/><text x="50" y="55" font-family="sans-serif" font-size="50" fill="white" text-anchor="middle" font-weight="bold">${title[0].toUpperCase()}</text></svg>`;
        const link = doc.querySelector("link[rel*='icon']");
        if (link && (link.href.startsWith('http') || link.href.startsWith('data:'))) icon = link.href;

        const blob = new Blob([content], {type: 'text/html'});
        const url = URL.createObjectURL(blob);
        
        grid.appendChild(createCard(Date.now(), title, icon, url));
        checkEmpty();
      };
      reader.readAsText(file);
    }

    function checkEmpty() {
      if (grid.children.length === 0) {
        emptyState.classList.add('visible');
        grid.style.display = 'none';
      } else {
        emptyState.classList.remove('visible');
        grid.style.display = 'grid';
      }
    }
    checkEmpty();

    document.getElementById('addBtn').addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => { if(e.target.files[0]) addGame(e.target.files[0]); });
    
    function getCards() {
      return Array.from(grid.querySelectorAll('.game-card'));
    }

    function setActiveIndex(index) {
      const cards = getCards();
      if (cards.length === 0) {
        activeIndex = -1;
        return;
      }
      const nextIndex = ((index % cards.length) + cards.length) % cards.length;
      activeIndex = nextIndex;
      cards.forEach((card, idx) => {
        card.classList.toggle('is-active', idx === activeIndex);
      });
      cards[activeIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
    }

    function activateFirstCard() {
      if (activeIndex === -1) setActiveIndex(0);
    }

    function applyUserName(name) {
      const safeName = (name || '').trim() || 'adhm';
      userNameEl.textContent = safeName;
      if (!userAvatarEl.style.backgroundImage) {
        userAvatarEl.textContent = safeName[0].toUpperCase();
      }
    }

    function applyUserAvatar(file) {
      const url = URL.createObjectURL(file);
      userAvatarEl.style.backgroundImage = `url("${url}")`;
      userAvatarEl.style.backgroundSize = 'cover';
      userAvatarEl.style.backgroundPosition = 'center';
      userAvatarEl.textContent = '';
    }

    userNameEl.addEventListener('click', () => {
      const newName = prompt('اكتب اسمك الجديد', userNameEl.textContent);
      if (newName !== null) applyUserName(newName);
    });

    userAvatarEl.addEventListener('click', () => {
      avatarInput.click();
    });

    avatarInput.addEventListener('change', (e) => {
      if (e.target.files[0]) applyUserAvatar(e.target.files[0]);
    });
    
    document.addEventListener('dragover', (e) => e.preventDefault());
    document.addEventListener('drop', (e) => {
      e.preventDefault();
      if (e.dataTransfer.files.length > 0) addGame(e.dataTransfer.files[0]);
    });

    function openGame(url) {
      frame.src = url;
      modal.classList.add('active');
    }
    document.getElementById('closeGame').addEventListener('click', () => {
      modal.classList.remove('active');
      frame.src = 'about:blank';
    });
    
    document.addEventListener('keydown', (e) => {
      if (modal.classList.contains('active')) return;
      if (['ArrowRight', 'ArrowLeft', 'ArrowUp', 'ArrowDown'].includes(e.key)) {
        e.preventDefault();
        activateFirstCard();
        const step = (e.key === 'ArrowRight' || e.key === 'ArrowDown') ? 1 : -1;
        setActiveIndex(activeIndex + step);
        playSound('hover');
        return;
      }

      if (e.key === 'Enter') {
        const cards = getCards();
        if (cards[activeIndex]) {
          e.preventDefault();
          cards[activeIndex].click();
        }
      }
    });
    
    document.addEventListener('click', (e) => {
      if (!ctxMenu.contains(e.target)) ctxMenu.style.display = 'none';
    });
    document.getElementById('ctxDelete').addEventListener('click', () => {
      if (contextTargetId) {
        document.querySelector(`.game-card[data-id="${contextTargetId}"]`).remove();
        checkEmpty();
      }
    });
  </script>
</body>
</html>
